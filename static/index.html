<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Twin - AI-Powered Real Estate Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#f59e0b',
                        dark: '#0f172a',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #1e40af; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app">
        <!-- Header -->
        <header class="bg-primary text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-building text-2xl"></i>
                    <h1 class="text-2xl font-bold">Digital Twin</h1>
                    <span class="text-sm bg-secondary px-2 py-1 rounded">Real Estate Command Center</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm">
                        <span v-if="systemStats.total_properties">{{ systemStats.total_properties }} Properties</span>
                        <span v-if="systemStats.total_contacts" class="ml-2">{{ systemStats.total_contacts }} Contacts</span>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-secondary flex items-center justify-center">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>Real Estate Pro</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-6 flex">
            <!-- Sidebar Navigation -->
            <nav class="w-64 bg-white rounded-lg shadow-md p-4 mr-6 h-fit sticky top-6">
                <ul class="space-y-2">
                    <li>
                        <button @click="showTab('dashboard')" :class="getTabClass('dashboard')">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </button>
                    </li>
                    <li>
                        <button @click="showTab('assistant')" :class="getTabClass('assistant')">
                            <i class="fas fa-robot"></i>
                            <span>AI Assistant</span>
                        </button>
                    </li>
                    <li>
                        <button @click="showTab('data-hub')" :class="getTabClass('data-hub')">
                            <i class="fas fa-database"></i>
                            <span>Data Hub</span>
                        </button>
                    </li>
                    <li>
                        <button @click="showTab('properties')" :class="getTabClass('properties')">
                            <i class="fas fa-building"></i>
                            <span>Properties</span>
                        </button>
                    </li>
                    <li>
                        <button @click="showTab('contacts')" :class="getTabClass('contacts')">
                            <i class="fas fa-address-book"></i>
                            <span>Contacts</span>
                        </button>
                    </li>
                    <li>
                        <button @click="showTab('analytics')" :class="getTabClass('analytics')">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </button>
                    </li>
                </ul>
            </nav>

            <!-- Main Content Area -->
            <main class="flex-1">
                <!-- Dashboard Tab -->
                <div v-show="activeTab === 'dashboard'" class="tab-content active fade-in">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2">Dashboard</h2>
                        <p class="text-gray-600">Your real estate command center - {{ new Date().toLocaleDateString() }}</p>
                    </div>
                    
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="dashboard-card bg-white rounded-xl shadow-md p-6 border-l-4 border-primary">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Active Properties</p>
                                    <p class="text-2xl font-bold text-primary">{{ dashboardStats.active_properties || 0 }}</p>
                                </div>
                                <i class="fas fa-building text-3xl text-primary opacity-20"></i>
                            </div>
                        </div>
                        <div class="dashboard-card bg-white rounded-xl shadow-md p-6 border-l-4 border-secondary">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Active Deals</p>
                                    <p class="text-2xl font-bold text-secondary">{{ dashboardStats.active_deals || 0 }}</p>
                                </div>
                                <i class="fas fa-handshake text-3xl text-secondary opacity-20"></i>
                            </div>
                        </div>
                        <div class="dashboard-card bg-white rounded-xl shadow-md p-6 border-l-4 border-accent">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Monthly Revenue</p>
                                    <p class="text-2xl font-bold text-accent">AED {{ formatCurrency(dashboardStats.revenue_30_days || 0) }}</p>
                                </div>
                                <i class="fas fa-dollar-sign text-3xl text-accent opacity-20"></i>
                            </div>
                        </div>
                        <div class="dashboard-card bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Pipeline Value</p>
                                    <p class="text-2xl font-bold text-green-600">AED {{ formatCurrency(dashboardStats.pipeline_value || 0) }}</p>
                                </div>
                                <i class="fas fa-chart-trend-up text-3xl text-green-500 opacity-20"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts and Daily Briefing -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Lead Scores Overview</h3>
                            <canvas id="leadScoresChart" height="250"></canvas>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-briefcase mr-2"></i>
                                Daily Briefing
                            </h3>
                            <div id="daily-briefing-content">
                                <div v-if="dailyBriefing.loading" class="flex items-center justify-center py-4">
                                    <div class="loader"></div>
                                    <span class="ml-2">Loading briefing...</span>
                                </div>
                                <div v-else-if="dailyBriefing.follow_ups && dailyBriefing.follow_ups.length > 0">
                                    <h4 class="font-medium mb-3 text-red-600">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        Urgent Follow-ups ({{ dailyBriefing.follow_ups.length }})
                                    </h4>
                                    <ul class="space-y-3">
                                        <li v-for="task in dailyBriefing.follow_ups.slice(0, 5)" :key="task.contact_id" 
                                            class="flex items-start p-3 bg-red-50 rounded-lg">
                                            <div class="bg-red-100 text-red-600 rounded-full p-2 mr-3 flex-shrink-0">
                                                <i class="fas fa-phone text-sm"></i>
                                            </div>
                                            <div class="flex-1">
                                                <p class="font-medium">{{ task.name }}</p>
                                                <p class="text-sm text-gray-600">{{ task.status }} lead - {{ task.days_overdue }} days overdue</p>
                                                <p class="text-xs text-gray-500" v-if="task.email">{{ task.email }}</p>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div v-else class="text-center py-8">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                                    <p class="font-medium text-green-600">All caught up!</p>
                                    <p class="text-sm text-gray-500">No urgent follow-ups needed today.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Tab -->
                <div v-show="activeTab === 'assistant'" class="tab-content fade-in">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2 flex items-center">
                            <i class="fas fa-robot mr-3 text-primary"></i>
                            AURA AI Assistant
                        </h2>
                        <p class="text-gray-600">Your intelligent real estate companion</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div id="chat-container" class="h-[600px] overflow-y-auto p-4 bg-gray-50">
                            <!-- Chat messages will be dynamically added here -->
                        </div>
                        <div class="border-t p-4 bg-white">
                            <div class="flex space-x-3">
                                <div class="flex-1 relative">
                                    <input 
                                        type="text" 
                                        v-model="userInput" 
                                        @keypress.enter="sendMessage" 
                                        placeholder="Ask AURA anything about your real estate business..." 
                                        class="w-full border rounded-lg py-3 px-4 pr-12 focus:outline-none focus:ring-2 focus:ring-primary"
                                        :disabled="isLoading"
                                    >
                                    <div v-if="isLoading" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                                        <div class="loader"></div>
                                    </div>
                                </div>
                                <button 
                                    @click="sendMessage" 
                                    class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" 
                                    :disabled="isLoading || !userInput.trim()"
                                >
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <div class="mt-2 flex flex-wrap gap-2">
                                <button 
                                    v-for="suggestion in quickSuggestions" 
                                    :key="suggestion"
                                    @click="userInput = suggestion"
                                    class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors"
                                >
                                    {{ suggestion }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Hub Tab -->
                <div v-show="activeTab === 'data-hub'" class="tab-content fade-in">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2">Data Hub</h2>
                        <p class="text-gray-600">Upload and manage your real estate documents</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- File Upload -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-cloud-upload-alt mr-2"></i>
                                Upload Documents
                            </h3>
                            <div 
                                id="drop-zone" 
                                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors"
                                @click="triggerFileInput"
                                @dragover.prevent
                                @drop.prevent="handleFileDrop"
                            >
                                <input type="file" id="file-input" class="hidden" multiple @change="handleFileSelect">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600 mb-2">Drag & drop files here or click to browse</p>
                                <p class="text-sm text-gray-500">Supports PDF, Excel, Word, images, and text files</p>
                            </div>
                            
                            <div v-if="selectedFiles.length > 0" class="mt-4">
                                <h4 class="font-medium mb-2">Selected Files:</h4>
                                <ul class="space-y-2">
                                    <li v-for="(file, index) in selectedFiles" :key="index" 
                                        class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                        <span class="text-sm">{{ file.name }}</span>
                                        <button @click="removeFile(index)" class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </li>
                                </ul>
                                <button 
                                    @click="uploadFiles" 
                                    class="mt-4 w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    :disabled="uploadingFiles"
                                >
                                    <span v-if="uploadingFiles">
                                        <div class="loader inline-block mr-2"></div>
                                        Uploading...
                                    </span>
                                    <span v-else>Upload Files</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Knowledge Base Stats -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-brain mr-2"></i>
                                Knowledge Base
                            </h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="font-medium">Total Documents</span>
                                    <span class="text-2xl font-bold text-primary">{{ knowledgeStats.total_items || 0 }}</span>
                                </div>
                                <div v-if="knowledgeStats.content_types" class="space-y-2">
                                    <h4 class="font-medium text-sm text-gray-600">Document Types</h4>
                                    <div v-for="(count, type) in knowledgeStats.content_types" :key="type" 
                                         class="flex justify-between text-sm">
                                        <span class="capitalize">{{ type }}</span>
                                        <span>{{ count }}</span>
                                    </div>
                                </div>
                                <div class="pt-2 border-t">
                                    <p class="text-sm text-gray-500">
                                        <i class="fas fa-plus-circle mr-1"></i>
                                        {{ knowledgeStats.recent_additions || 0 }} new documents this week
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Properties Tab -->
                <div v-show="activeTab === 'properties'" class="tab-content fade-in">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2">Properties</h2>
                        <p class="text-gray-600">Manage your property portfolio</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Property Listings</h3>
                                <div class="flex space-x-3">
                                    <input 
                                        type="text" 
                                        v-model="propertySearch" 
                                        placeholder="Search properties..." 
                                        class="border rounded-lg px-3 py-2 text-sm"
                                    >
                                    <select v-model="propertyFilter" class="border rounded-lg px-3 py-2 text-sm">
                                        <option value="">All Status</option>
                                        <option value="Available">Available</option>
                                        <option value="Sold">Sold</option>
                                        <option value="Under Contract">Under Contract</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left p-4 font-medium">Property</th>
                                        <th class="text-left p-4 font-medium">Type</th>
                                        <th class="text-left p-4 font-medium">Area</th>
                                        <th class="text-left p-4 font-medium">Specs</th>
                                        <th class="text-left p-4 font-medium">Price</th>
                                        <th class="text-left p-4 font-medium">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="properties.loading">
                                        <td colspan="6" class="text-center p-8">
                                            <div class="loader mx-auto"></div>
                                            <p class="mt-2">Loading properties...</p>
                                        </td>
                                    </tr>
                                    <tr v-else-if="filteredProperties.length === 0">
                                        <td colspan="6" class="text-center p-8 text-gray-500">
                                            No properties found matching your criteria
                                        </td>
                                    </tr>
                                    <tr v-else v-for="property in filteredProperties" :key="property.id" 
                                        class="border-t hover:bg-gray-50">
                                        <td class="p-4">
                                            <div>
                                                <p class="font-medium">{{ property.building }}</p>
                                                <p class="text-sm text-gray-500">Unit {{ property.unit }}</p>
                                            </div>
                                        </td>
                                        <td class="p-4">{{ property.property_type }}</td>
                                        <td class="p-4">{{ property.area }}</td>
                                        <td class="p-4">
                                            <span class="text-sm">{{ property.bedrooms }}BR / {{ property.bathrooms }}BA</span>
                                            <br>
                                            <span class="text-xs text-gray-500">{{ property.size_sqft }} sqft</span>
                                        </td>
                                        <td class="p-4">
                                            <span class="font-bold">AED {{ formatCurrency(property.price) }}</span>
                                        </td>
                                        <td class="p-4">
                                            <span :class="getStatusClass(property.status)">
                                                {{ property.status }}
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div v-show="activeTab === 'contacts'" class="tab-content fade-in">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2">Contacts</h2>
                        <p class="text-gray-600">Manage your client relationships</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Contact Directory</h3>
                                <div class="flex space-x-3">
                                    <input 
                                        type="text" 
                                        v-model="contactSearch" 
                                        placeholder="Search contacts..." 
                                        class="border rounded-lg px-3 py-2 text-sm"
                                    >
                                    <select v-model="contactFilter" class="border rounded-lg px-3 py-2 text-sm">
                                        <option value="">All Leads</option>
                                        <option value="Hot">Hot</option>
                                        <option value="Warm">Warm</option>
                                        <option value="Cold">Cold</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="text-left p-4 font-medium">Name</th>
                                        <th class="text-left p-4 font-medium">Contact Info</th>
                                        <th class="text-left p-4 font-medium">Lead Status</th>
                                        <th class="text-left p-4 font-medium">Last Contact</th>
                                        <th class="text-left p-4 font-medium">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="contacts.loading">
                                        <td colspan="5" class="text-center p-8">
                                            <div class="loader mx-auto"></div>
                                            <p class="mt-2">Loading contacts...</p>
                                        </td>
                                    </tr>
                                    <tr v-else-if="filteredContacts.length === 0">
                                        <td colspan="5" class="text-center p-8 text-gray-500">
                                            No contacts found matching your criteria
                                        </td>
                                    </tr>
                                    <tr v-else v-for="contact in filteredContacts" :key="contact.id" 
                                        class="border-t hover:bg-gray-50">
                                        <td class="p-4">
                                            <p class="font-medium">{{ contact.name }}</p>
                                        </td>
                                        <td class="p-4">
                                            <p class="text-sm">{{ contact.email }}</p>
                                            <p class="text-sm text-gray-500">{{ contact.phone }}</p>
                                        </td>
                                        <td class="p-4">
                                            <span :class="getLeadStatusClass(contact.lead_status)">
                                                {{ contact.lead_status }}
                                            </span>
                                        </td>
                                        <td class="p-4">
                                            <span class="text-sm">
                                                {{ formatDate(contact.last_contacted_date || contact.created_date) }}
                                            </span>
                                        </td>
                                        <td class="p-4">
                                            <button @click="startFollowUp(contact)" 
                                                    class="text-primary hover:text-blue-700 mr-2">
                                                <i class="fas fa-phone"></i>
                                            </button>
                                            <button @click="sendEmail(contact)" 
                                                    class="text-secondary hover:text-blue-600">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div v-show="activeTab === 'analytics'" class="tab-content fade-in">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold mb-2">Analytics</h2>
                        <p class="text-gray-600">Performance insights and lead scoring</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Lead Scoring -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-trophy mr-2"></i>
                                Top Leads by Score
                            </h3>
                            <div v-if="leadScores.loading" class="text-center py-4">
                                <div class="loader mx-auto"></div>
                                <p class="mt-2">Calculating scores...</p>
                            </div>
                            <div v-else-if="leadScores.data.length === 0" class="text-center py-4 text-gray-500">
                                No lead scores available
                            </div>
                            <div v-else class="space-y-3">
                                <div v-for="lead in leadScores.data.slice(0, 5)" :key="lead.contact_id" 
                                     class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-1">
                                        <p class="font-medium">{{ lead.name }}</p>
                                        <p class="text-sm text-gray-500">{{ lead.lead_status }} â€¢ {{ lead.source }}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-lg font-bold" :class="getScoreColor(lead.score)">{{ lead.score }}</p>
                                        <p class="text-xs text-gray-500">{{ lead.priority_level }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Metrics -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4 flex items-center">
                                <i class="fas fa-chart-bar mr-2"></i>
                                Performance Metrics
                            </h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="font-medium">Conversion Rate</span>
                                    <span class="text-xl font-bold text-green-600">{{ performanceMetrics.conversion_rate || 0 }}%</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="font-medium">Avg Deal Size</span>
                                    <span class="text-xl font-bold text-blue-600">AED {{ formatCurrency(performanceMetrics.average_deal_size || 0) }}</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                    <span class="font-medium">Task Completion</span>
                                    <span class="text-xl font-bold text-purple-600">{{ performanceMetrics.task_completion_rate || 0 }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick, computed } = Vue

        createApp({
            setup() {
                // Reactive state
                const activeTab = ref('dashboard');
                const selectedFiles = ref([]);
                const userInput = ref('');
                const isLoading = ref(false);
                const uploadingFiles = ref(false);
                
                // Data stores
                const systemStats = ref({});
                const dashboardStats = ref({});
                const dailyBriefing = ref({ loading: true, follow_ups: [] });
                const knowledgeStats = ref({});
                const properties = ref({ loading: true, data: [] });
                const contacts = ref({ loading: true, data: [] });
                const leadScores = ref({ loading: true, data: [] });
                const performanceMetrics = ref({});
                
                // Filters and search
                const propertySearch = ref('');
                const propertyFilter = ref('');
                const contactSearch = ref('');
                const contactFilter = ref('');
                
                // Quick suggestions for AI assistant
                const quickSuggestions = ref([
                    'Show me follow-ups',
                    'Who owns Palm Tower Unit 3401?',
                    'Create task: Follow up with Ahmed',
                    'Find buyers for Marina Residences',
                    'Score my leads',
                    'Search properties in Downtown'
                ]);

                // Computed properties
                const filteredProperties = computed(() => {
                    let filtered = properties.value.data;
                    
                    if (propertySearch.value) {
                        const search = propertySearch.value.toLowerCase();
                        filtered = filtered.filter(p => 
                            p.building.toLowerCase().includes(search) ||
                            p.unit.toLowerCase().includes(search) ||
                            p.area.toLowerCase().includes(search)
                        );
                    }
                    
                    if (propertyFilter.value) {
                        filtered = filtered.filter(p => p.status === propertyFilter.value);
                    }
                    
                    return filtered;
                });
                
                const filteredContacts = computed(() => {
                    let filtered = contacts.value.data;
                    
                    if (contactSearch.value) {
                        const search = contactSearch.value.toLowerCase();
                        filtered = filtered.filter(c => 
                            c.name.toLowerCase().includes(search) ||
                            c.email.toLowerCase().includes(search) ||
                            c.phone.toLowerCase().includes(search)
                        );
                    }
                    
                    if (contactFilter.value) {
                        filtered = filtered.filter(c => c.lead_status === contactFilter.value);
                    }
                    
                    return filtered;
                });

                // Navigation
                const showTab = (tabId) => {
                    activeTab.value = tabId;
                    
                    // Load data when switching tabs
                    if (tabId === 'properties') {
                        loadProperties();
                    } else if (tabId === 'contacts') {
                        loadContacts();
                    } else if (tabId === 'analytics') {
                        loadAnalytics();
                    } else if (tabId === 'data-hub') {
                        loadKnowledgeStats();
                    }
                };

                const getTabClass = (tabId) => {
                    const base = 'w-full text-left px-4 py-3 rounded-lg flex items-center space-x-3 transition-colors';
                    return activeTab.value === tabId ? 
                        `${base} bg-primary text-white` : 
                        `${base} hover:bg-gray-100`;
                };

                // Chat functionality
                const addMessage = async (content, sender) => {
                    const chatContainer = document.getElementById('chat-container');
                    if (!chatContainer) return;
                    
                    const message = document.createElement('div');
                    message.className = `chat-message mb-4 flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                    
                    if (sender === 'user') {
                        message.innerHTML = `
                            <div class="bg-primary text-white rounded-lg p-3 max-w-[80%] shadow-md">
                                <p class="text-sm">${content}</p>
                            </div>
                        `;
                    } else {
                        message.innerHTML = `
                            <div class="bg-gray-200 rounded-lg p-3 max-w-[80%] shadow-md">
                                <div class="flex items-center mb-1">
                                    <i class="fas fa-robot text-primary mr-2"></i>
                                    <span class="text-xs font-medium text-gray-600">AURA</span>
                                </div>
                                <p class="text-sm whitespace-pre-wrap">${content}</p>
                            </div>
                        `;
                    }
                    
                    chatContainer.appendChild(message);
                    await nextTick();
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                };

                const sendMessage = async () => {
                    const messageText = userInput.value.trim();
                    if (!messageText || isLoading.value) return;
                    
                    addMessage(messageText, 'user');
                    userInput.value = '';
                    isLoading.value = true;
                    
                    try {
                        const response = await fetch('/api/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: messageText })
                        });
                        
                        const data = await response.json();
                        addMessage(data.message || data.error || 'No response received', 'aura');
                    } catch (error) {
                        addMessage('I\'m experiencing connection issues. Please try again.', 'aura');
                    } finally {
                        isLoading.value = false;
                    }
                };

                // File handling
                const triggerFileInput = () => {
                    document.getElementById('file-input').click();
                };

                const handleFileSelect = (event) => {
                    const files = Array.from(event.target.files);
                    selectedFiles.value = [...selectedFiles.value, ...files];
                };

                const handleFileDrop = (event) => {
                    const files = Array.from(event.dataTransfer.files);
                    selectedFiles.value = [...selectedFiles.value, ...files];
                };

                const removeFile = (index) => {
                    selectedFiles.value.splice(index, 1);
                };

                const uploadFiles = async () => {
                    if (selectedFiles.value.length === 0) return;
                    
                    uploadingFiles.value = true;
                    const formData = new FormData();
                    
                    selectedFiles.value.forEach(file => {
                        formData.append('files', file);
                    });
                    
                    try {
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            alert('Files uploaded successfully!');
                            selectedFiles.value = [];
                            loadKnowledgeStats();
                        } else {
                            alert(`Upload failed: ${data.error}`);
                        }
                    } catch (error) {
                        alert('Upload failed due to connection error');
                    } finally {
                        uploadingFiles.value = false;
                        document.getElementById('file-input').value = '';
                    }
                };

                // Data loading functions
                const loadDashboardData = async () => {
                    try {
                        // Load dashboard stats
                        const dashboardResponse = await fetch('/api/dashboard/stats');
                        if (dashboardResponse.ok) {
                            const dashboardData = await dashboardResponse.json();
                            if (dashboardData.success) {
                                dashboardStats.value = dashboardData.stats;
                            }
                        }

                        // Load performance metrics
                        const metricsResponse = await fetch('/api/analytics/performance');
                        if (metricsResponse.ok) {
                            const metricsData = await metricsResponse.json();
                            performanceMetrics.value = metricsData;
                        }

                        // Load daily briefing
                        const briefingResponse = await fetch('/api/daily-briefing');
                        if (briefingResponse.ok) {
                            const briefingData = await briefingResponse.json();
                            dailyBriefing.value = { ...briefingData, loading: false };
                        } else {
                            dailyBriefing.value = { loading: false, follow_ups: [] };
                        }

                        // Get system stats
                        const [propsResponse, contactsResponse] = await Promise.all([
                            fetch('/api/properties'),
                            fetch('/api/contacts')
                        ]);
                        
                        if (propsResponse.ok && contactsResponse.ok) {
                            const propsData = await propsResponse.json();
                            const contactsData = await contactsResponse.json();
                            
                            systemStats.value = {
                                total_properties: propsData.properties?.length || 0,
                                total_contacts: contactsData.contacts?.length || 0
                            };
                        }
                    } catch (error) {
                        console.error('Error loading dashboard data:', error);
                    }
                };

                const loadProperties = async () => {
                    properties.value.loading = true;
                    try {
                        const response = await fetch('/api/properties');
                        if (response.ok) {
                            const data = await response.json();
                            properties.value = { 
                                loading: false, 
                                loaded: true, 
                                data: data.properties || [] 
                            };
                            console.log('Properties loaded:', data.properties?.length || 0);
                        } else {
                            console.error('Failed to load properties:', response.status);
                            properties.value = { loading: false, loaded: true, data: [] };
                        }
                    } catch (error) {
                        console.error('Error loading properties:', error);
                        properties.value = { loading: false, loaded: true, data: [] };
                    }
                };

                const loadContacts = async () => {
                    contacts.value.loading = true;
                    try {
                        const response = await fetch('/api/contacts');
                        if (response.ok) {
                            const data = await response.json();
                            contacts.value = { 
                                loading: false, 
                                loaded: true, 
                                data: data.contacts || [] 
                            };
                            console.log('Contacts loaded:', data.contacts?.length || 0);
                        } else {
                            console.error('Failed to load contacts:', response.status);
                            contacts.value = { loading: false, loaded: true, data: [] };
                        }
                    } catch (error) {
                        console.error('Error loading contacts:', error);
                        contacts.value = { loading: false, loaded: true, data: [] };
                    }
                };

                const loadAnalytics = async () => {
                    leadScores.value.loading = true;
                    try {
                        const response = await fetch('/api/analytics/leads');
                        if (response.ok) {
                            const data = await response.json();
                            leadScores.value = { 
                                loading: false, 
                                loaded: true, 
                                data: data.lead_scores || [] 
                            };
                            console.log('Analytics loaded:', data.lead_scores?.length || 0);
                        } else {
                            console.error('Failed to load analytics:', response.status);
                            leadScores.value = { loading: false, loaded: true, data: [] };
                        }
                    } catch (error) {
                        console.error('Error loading analytics:', error);
                        leadScores.value = { loading: false, loaded: true, data: [] };
                    }
                };

                const loadKnowledgeStats = async () => {
                    try {
                        const response = await fetch('/api/knowledge/stats');
                        if (response.ok) {
                            const data = await response.json();
                            knowledgeStats.value = data;
                        } else {
                            knowledgeStats.value = {
                                total_items: 0,
                                content_types: {},
                                recent_additions: 0
                            };
                        }
                    } catch (error) {
                        console.error('Error loading knowledge stats:', error);
                        knowledgeStats.value = {
                            total_items: 0,
                            content_types: {},
                            recent_additions: 0
                        };
                    }
                };

                // Utility functions
                const formatCurrency = (amount) => {
                    if (!amount) return '0';
                    return new Intl.NumberFormat('en-AE').format(amount);
                };

                const formatDate = (dateString) => {
                    if (!dateString) return 'Never';
                    try {
                        return new Date(dateString).toLocaleDateString();
                    } catch {
                        return 'Invalid Date';
                    }
                };

                const getStatusClass = (status) => {
                    const classes = {
                        'Available': 'px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full',
                        'Sold': 'px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full',
                        'Under Contract': 'px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full'
                    };
                    return classes[status] || 'px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full';
                };

                const getLeadStatusClass = (status) => {
                    const classes = {
                        'Hot': 'px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full',
                        'Warm': 'px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full',
                        'Cold': 'px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full'
                    };
                    return classes[status] || 'px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full';
                };

                const getScoreColor = (score) => {
                    if (score >= 80) return 'text-red-600';
                    if (score >= 60) return 'text-yellow-600';
                    return 'text-green-600';
                };

                // Action functions
                const startFollowUp = (contact) => {
                    userInput.value = `Create follow-up task for ${contact.name}`;
                    showTab('assistant');
                };

                const sendEmail = (contact) => {
                    userInput.value = `Draft follow-up email for ${contact.name}`;
                    showTab('assistant');
                };

                // Lifecycle
                onMounted(async () => {
                    // Initialize chat with welcome message
                    await nextTick();
                    addMessage('Welcome to your Digital Twin Command Center! I\'m AURA, your AI real estate assistant. How can I help you today?', 'aura');
                    
                    // Load initial dashboard data
                    await loadDashboardData();
                    await loadKnowledgeStats();
                    
                    // Pre-load properties and contacts for instant access
                    await loadProperties();
                    await loadContacts();
                    await loadAnalytics();
                    
                    console.log('All data loaded successfully');
                });

                return {
                    // State
                    activeTab,
                    selectedFiles,
                    userInput,
                    isLoading,
                    uploadingFiles,
                    quickSuggestions,
                    
                    // Data
                    systemStats,
                    dashboardStats,
                    dailyBriefing,
                    knowledgeStats,
                    properties,
                    contacts,
                    leadScores,
                    performanceMetrics,
                    
                    // Filters
                    propertySearch,
                    propertyFilter,
                    contactSearch,
                    contactFilter,
                    
                    // Computed
                    filteredProperties,
                    filteredContacts,
                    
                    // Methods
                    showTab,
                    getTabClass,
                    sendMessage,
                    triggerFileInput,
                    handleFileSelect,
                    handleFileDrop,
                    removeFile,
                    uploadFiles,
                    formatCurrency,
                    formatDate,
                    getStatusClass,
                    getLeadStatusClass,
                    getScoreColor,
                    startFollowUp,
                    sendEmail
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
